from django.shortcuts import get_object_or_404
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import *
from .data_to_app import passenger_reservationSerializer, TrainSerializer
import json
import django
class passenger_list(APIView):

        def get(self, request):
            passengers = passenger_reservation.objects.all()
            serializer = passenger_reservationSerializer(passengers, many=True)
            return Response(serializer.data)

        def post(self, request):
            # print("Working")
            print("request.data is : ")
            print(request.data)

            if request.data is None or '':
                return Response("Null Request!")

            if isinstance(request.data, django.http.request.QueryDict):
                aa = request.data.dict()
                aa = list(aa.keys())[0]
                print("aa is "+str(aa))
                print("Type of aa is "+str(type(aa)))
                json_obj = json.loads(aa)
                print("Query Dict")
            else:
                json_obj = request.data
                print("Only Dict")
            req_keys=list(json_obj.keys())
            print("JSON OBJECT IS : ")
            print(json_obj)
            print("Request Keys are : ")
            print(req_keys)
            print("Request Values are : ")
            print(list(json_obj.values()))
            if req_keys[0] == "update_values":
                pnrs_to_update = list(json_obj.values())
                if isinstance(pnrs_to_update[0][0], list):
                    pnrs_to_update = pnrs_to_update[0]
                print("pnrs_to_update is : ")
                print(pnrs_to_update)
                updated_for=[]
                for p in range(len(pnrs_to_update)):
                    a=passenger_reservation.objects.get(pnr=int(pnrs_to_update[p][0]), seat_no=pnrs_to_update[p][1], coach_no=pnrs_to_update[p][2])
                    a.verification_status='V'
                    a.save()
                    updated_for.append(pnrs_to_update[p])
                return Response("Updated")
            elif req_keys[0] == "train_info":
                train_no = json_obj["train_info"]
                t_r = Train.objects.filter(train_no=train_no)
                #route = t_r.stopages_list.values()
                trains = TrainSerializer(t_r, many=True)
                return Response(trains.data)
                # seriealizer = TrainSerializer()
                # return Response(serializer.data)
            elif req_keys[0] == "mark_as_vacant":
                coach_and_seat = list(json_obj.values())
                a = passenger_reservation.objects.get(coach_no=coach_and_seat[0], seat_no=coach_and_seat[1], train_no=coach_and_seat[2])
                a.verification_status='U'
                a.save()
                return Response("CHANGED!!")
            else:
                print("LAST CONDITION")
                try:
                    passengers = passenger_reservation.objects.filter(**json_obj)
                    serializer = passenger_reservationSerializer(passengers, many=True)
                    return Response(serializer.data)
                except:

                    return Response("Invalid Request!")
